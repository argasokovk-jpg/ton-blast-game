<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Blast Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .tg-header {
            background: linear-gradient(45deg, #0088cc, #00cc88);
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0,136,204,0.3);
        }
        
        .tg-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        #user-info {
            font-size: 16px;
            opacity: 0.9;
        }

        #owner-profit {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 14px;
            display: inline-block;
        }
        
        .content-section {
            padding: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .wallet-card {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 4px solid #fdcb6e;
        }
        
        .game-card {
            background: linear-gradient(135deg, #d0f0fd, #a8e6cf);
            border-left: 4px solid #0088cc;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #2196f3;
        }
        
        .referral-card {
            background: linear-gradient(135deg, #f0f4ff, #d0d8ff);
            border-left: 4px solid #7e57c2;
        }
        
        h2 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        h3 {
            color: #0088cc;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤ —Å—Ç–∏–ª–µ Telegram */
        .tg-button {
            background: linear-gradient(45deg, #0088cc, #00a8ff);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(0,136,204,0.3);
            transition: all 0.3s ease;
            display: inline-block;
            text-align: center;
        }
        
        .tg-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,136,204,0.4);
        }
        
        .tg-button.secondary {
            background: linear-gradient(45deg, #00cc88, #00e5a0);
        }
        
        .tg-button.small {
            padding: 10px 20px;
            font-size: 14px;
        }
        
        .tg-button.danger {
            background: linear-gradient(45deg, #ff4757, #ff3838);
        }

        .tg-button.success {
            background: linear-gradient(45deg, #00b894, #00a085);
        }
        
        /* –ò–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å */
        #game-area {
            position: relative;
            width: 100%;
            height: 400px;
            border: 3px solid #0088cc;
            border-radius: 15px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }
        
        /* TON —à–∞—Ä–∏–∫–∏ */
        .ton-coin {
            width: 70px;
            height: 70px;
            background: radial-gradient(circle at 30% 30%, #0088cc, #0066aa, #004477);
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 
                0 0 25px rgba(0, 136, 204, 0.8),
                inset 0 0 25px rgba(255, 255, 255, 0.3),
                0 0 0 3px rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            animation: float 3s infinite ease-in-out;
            transition: all 0.3s ease;
        }
        
        .ton-coin::before {
            content: "üíé";
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .ton-coin:hover {
            transform: scale(1.15);
            box-shadow: 
                0 0 35px rgba(0, 136, 204, 1),
                inset 0 0 30px rgba(255, 255, 255, 0.4),
                0 0 0 4px rgba(255, 255, 255, 0.7);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        /* –¢–∞–π–º–µ—Ä –∏ —Å—á–µ—Ç */
        .game-info {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .timer {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
        }
        
        .score {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
        }
        
        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã */
        #game-result {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #e0ffe0, #c8f7c5);
            border-left: 4px solid #27ae60;
            margin: 20px 0;
        }
        
        /* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ */
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background: rgba(0, 136, 204, 0.05);
            border-radius: 10px;
            border-left: 3px solid #0088cc;
        }
        
        .leaderboard-rank {
            font-weight: bold;
            color: #0088cc;
            min-width: 30px;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #27ae60;
        }
        
        /* –ë–ª–æ–∫ —Å—Ç–∞–≤–æ–∫ */
        .bet-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
            justify-content: center;
        }
        
        .balance-info {
            background: rgba(0,136,204,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .commission-info {
            background: linear-gradient(135deg, #fff9e6, #ffeaa7);
            border: 2px solid #fdcb6e;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            .content-section {
                padding: 15px;
            }
            
            .tg-header {
                padding: 20px 15px;
            }
            
            .tg-header h1 {
                font-size: 24px;
            }
            
            #game-area {
                height: 350px;
            }
            
            .ton-coin {
                width: 60px;
                height: 60px;
            }
            
            .tg-button {
                padding: 12px 20px;
                font-size: 14px;
                display: block;
                width: 100%;
                margin: 8px 0;
            }
            
            .bet-buttons .tg-button {
                display: inline-block;
                width: auto;
                flex: 1;
                min-width: 70px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ Telegram -->
        <div class="tg-header">
            <h1>üéÆ TON Blast Game</h1>
            <div id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="owner-profit" style="display: none;"></div>
        </div>
        
        <div class="content-section">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ -->
            <div class="card wallet-card" id="wallet-section">
                <h2>üîó TON –ö–æ—à–µ–ª–µ–∫</h2>
                <div id="wallet-info">
                    <p>–î–ª—è –∏–≥—Ä—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ TON –∫–æ—à–µ–ª—å–∫–∞</p>
                    <button class="tg-button" onclick="connectWallet()">
                        üéØ Connect TON Wallet
                    </button>
                </div>
                
                <!-- –ë–ª–æ–∫ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞ -->
                <div id="after-connect" style="display: none; margin-top: 15px;">
                    <h3>üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å</h3>
                    <div class="balance-info">
                        <div style="font-size: 18px; font-weight: bold; color: #0088cc;">
                            üíé <span id="game-coins-balance">0</span> –º–æ–Ω–µ—Ç
                        </div>
                        <div style="font-size: 16px; color: #666; margin-top: 5px;">
                            üíµ <span id="ton-balance">0</span> TON
                        </div>
                    </div>

                    <div class="commission-info">
                        <h4>‚ö° –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–ª–∞—Ç</h4>
                        <p style="font-size: 14px; margin: 5px 0;">
                            üí∞ 1000 –º–æ–Ω–µ—Ç = 45 TON<br>
                            üéØ –ö–æ–º–∏—Å—Å–∏—è: 10%<br>
                            üìä –í—ã –ø–æ–ª—É—á–∏—Ç–µ: 40.5 TON
                        </p>
                    </div>
                    
                    <h3>üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–≤–∫—É</h3>
                    <div class="bet-buttons">
                        <button class="tg-button small" onclick="placeBet(1)">1 TON</button>
                        <button class="tg-button small" onclick="placeBet(2)">2 TON</button>
                        <button class="tg-button small" onclick="placeBet(5)">5 TON</button>
                        <button class="tg-button small" onclick="placeBet(10)">10 TON</button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="tg-button success" onclick="showWithdrawModal()" style="flex: 1;">
                            üí∏ –í—ã–≤–µ—Å—Ç–∏
                        </button>
                        <button class="tg-button danger" onclick="disconnectWallet()" style="flex: 1;">
                            üîå –û—Ç–∫–ª—é—á–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ò–≥—Ä–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card stats-card" id="game-stats" style="display: none;">
                <div class="game-info">
                    <div class="timer">‚è±Ô∏è <span id="time-left">30</span>—Å</div>
                    <div class="score">üíé <span id="coins-count">0</span></div>
                </div>
                <div style="text-align: center; color: #666; margin: 10px 0;">
                    üí∞ –°—Ç–∞–≤–∫–∞: <span id="current-bet">0</span> TON | 
                    –î–æ—Å—Ç—É–ø–Ω–æ: <span id="withdraw-amount">0</span> TON
                </div>
            </div>
            
            <!-- –ò–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
            <div id="game-area"></div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã -->
            <div class="card result-card" id="game-result">
                <h2 id="result-title">üéÆ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                <div id="result-details" style="margin: 15px 0;"></div>
                <button class="tg-button" onclick="resetGame()">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                <button class="tg-button secondary" onclick="shareResult()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </div>
            
            <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
            <div class="card">
                <h3>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h3>
                <div id="leaderboard"></div>
            </div>
            
            <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
            <div class="card referral-card">
                <h3>üë• –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π</h3>
                <p>–ü–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π!</p>
                <button class="tg-button small" onclick="copyReferralLink()">
                    üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                </button>
            </div>
        </div>
    </div>

    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        if (tg.initDataUnsafe.user) {
            let user = tg.initDataUnsafe.user;
            let userName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            document.getElementById('user-info').innerHTML = `üë§ <strong>${userName}</strong>`;
        }

        // –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
        let score = 0;
        let gameTimer = 30;
        let timerInterval;
        let gameInterval;
        let playerWallet = null;
        let tonConnectUI;
        let currentBet = 0;
        let userBalance = 50; // –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –¥–µ–º–æ
        let gameCoins = parseInt(localStorage.getItem('tonBlastGameCoins') || '0');

        const gameArea = document.getElementById('game-area');
        const walletSection = document.getElementById('wallet-section');
        const gameStats = document.getElementById('game-stats');
        const gameResult = document.getElementById('game-result');
        const resultTitle = document.getElementById('result-title');
        const resultDetails = document.getElementById('result-details');
        const leaderboardElement = document.getElementById('leaderboard');
        const afterConnect = document.getElementById('after-connect');
        const ownerProfitElement = document.getElementById('owner-profit');

        // –¢—Ä–µ–∫–µ—Ä —Ç–≤–æ–∏—Ö –¥–æ—Ö–æ–¥–æ–≤
        const profitTracker = {
            totalCommission: 0,
            totalWithdrawals: 0,
            
            addProfit: function(commission) {
                this.totalCommission += commission;
                this.totalWithdrawals++;
                this.saveToLocalStorage();
                this.displayProfit();
            },
            
            displayProfit: function() {
                console.log(`üí∞ –í–∞—à–∞ –ø—Ä–∏–±—ã–ª—å: ${this.totalCommission.toFixed(2)} TON (—Å ${this.totalWithdrawals} –≤—ã–≤–æ–¥–æ–≤)`);
                
                if (ownerProfitElement) {
                    ownerProfitElement.style.display = 'inline-block';
                    ownerProfitElement.innerHTML = `üëë –ü—Ä–∏–±—ã–ª—å: ${this.totalCommission.toFixed(2)} TON`;
                }
            },
            
            saveToLocalStorage: function() {
                localStorage.setItem('tonBlastOwnerProfit', JSON.stringify({
                    commission: this.totalCommission,
                    withdrawals: this.totalWithdrawals
                }));
            },
            
            loadFromLocalStorage: function() {
                const saved = JSON.parse(localStorage.getItem('tonBlastOwnerProfit') || '{"commission":0,"withdrawals":0}');
                this.totalCommission = saved.commission;
                this.totalWithdrawals = saved.withdrawals;
                this.displayProfit();
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect
        function initTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://ton-blast-game.vercel.app/tonconnect-manifest.json'
                });
                
                tonConnectUI.connectionRestored.then((value) => {
                    if (value) {
                        playerWallet = value;
                        updateWalletInfo();
                    }
                });
                
            } catch (error) {
                console.error('TON Connect init error:', error);
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        async function connectWallet() {
            try {
                const wallet = await tonConnectUI.connectWallet();
                playerWallet = wallet;
                updateWalletInfo();
            } catch (error) {
                console.error('Connection error:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞');
            }
        }

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        function disconnectWallet() {
            tonConnectUI.disconnect();
            playerWallet = null;
            afterConnect.style.display = 'none';
            document.getElementById('wallet-info').innerHTML = `
                <p>–î–ª—è –∏–≥—Ä—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ TON –∫–æ—à–µ–ª—å–∫–∞</p>
                <button class="tg-button" onclick="connectWallet()">
                    üéØ Connect TON Wallet
                </button>
            `;
            walletSection.classList.add('wallet-card');
            gameStats.style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ—à–µ–ª—å–∫–µ
        function updateWalletInfo() {
            if (playerWallet) {
                const shortAddress = playerWallet.account.address.slice(0, 8) + '...' + playerWallet.account.address.slice(-8);
                document.getElementById('wallet-info').innerHTML = `
                    <h3>‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω</h3>
                    <p style="font-size: 14px; color: #666; margin: 10px 0;">–ê–¥—Ä–µ—Å: ${shortAddress}</p>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –±–∞–ª–∞–Ω—Å–æ–º –∏ —Å—Ç–∞–≤–∫–∞–º–∏
                afterConnect.style.display = 'block';
                updateBalanceDisplay();
                
                walletSection.classList.remove('wallet-card');
                walletSection.style.background = 'linear-gradient(135deg, #e0ffe0, #c8f7c5)';
                walletSection.style.borderLeftColor = '#27ae60';
                
                gameStats.style.display = 'block';
                loadLeaderboard();
                profitTracker.loadFromLocalStorage();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
        function updateBalanceDisplay() {
            document.getElementById('game-coins-balance').textContent = gameCoins;
            document.getElementById('ton-balance').textContent = userBalance.toFixed(2);
            document.getElementById('withdraw-amount').textContent = Math.floor(gameCoins / 1000) * 40.5;
        }

        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
        function placeBet(amount) {
            if (userBalance < amount) {
                alert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON –Ω–∞ –±–∞–ª–∞–Ω—Å–µ!');
                return;
            }
            
            currentBet = amount;
            userBalance -= amount; // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            afterConnect.style.display = 'none';
            document.getElementById('wallet-info').innerHTML += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 15px; text-align: center;">
                    <h3>üí∞ –°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!</h3>
                    <p style="font-size: 18px; font-weight: bold; color: #0088cc;">${amount} TON</p>
                    <button class="tg-button" onclick="startGame()" style="margin-top: 10px;">
                        üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
                    </button>
                </div>
            `;
            
            updateBalanceDisplay();
            document.getElementById('current-bet').textContent = currentBet;
        }

        // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
        function startGame() {
            score = 0;
            gameTimer = 30;
            updateGameUI();
            
            gameArea.style.display = 'block';
            gameArea.innerHTML = '';
            gameResult.style.display = 'none';
            
            startTimer();
            createCoins();
        }

        // –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                gameTimer--;
                document.getElementById('time-left').textContent = gameTimer;
                
                if (gameTimer <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ TON —à–∞—Ä–∏–∫–æ–≤
        function createCoins() {
            clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                createSingleCoin();
            }, 800);
        }

        function createSingleCoin() {
            const coin = document.createElement('div');
            coin.className = 'ton-coin';
            
            const maxX = gameArea.offsetWidth - 80;
            const maxY = gameArea.offsetHeight - 80;
            coin.style.left = Math.random() * maxX + 'px';
            coin.style.top = Math.random() * maxY + 'px';
            
            coin.onclick = function() {
                collectCoin(this);
            };
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (coin.parentNode) {
                    coin.style.opacity = '0.5';
                    coin.style.background = 'radial-gradient(circle, #666666, #444444)';
                    setTimeout(() => {
                        if (coin.parentNode) gameArea.removeChild(coin);
                    }, 500);
                }
            }, 4000);
            
            gameArea.appendChild(coin);
        }

        // –°–±–æ—Ä –º–æ–Ω–µ—Ç—ã
        function collectCoin(coinElement) {
            coinElement.style.transform = 'scale(1.3)';
            coinElement.style.opacity = '0.7';
            
            setTimeout(() => {
                if (coinElement.parentNode) {
                    gameArea.removeChild(coinElement);
                    score += 100;
                    gameCoins += 100;
                    localStorage.setItem('tonBlastGameCoins', gameCoins.toString());
                    updateGameUI();
                    updateBalanceDisplay();
                }
            }, 150);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ UI
        function updateGameUI() {
            document.getElementById('coins-count').textContent = score;
            document.getElementById('withdraw-amount').textContent = Math.floor(gameCoins / 1000) * 40.5;
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
        function endGame() {
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            
            gameArea.style.display = 'none';
            gameResult.style.display = 'block';
            
            // –†–∞—Å—á–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞
            const winMultiplier = 1 + (score / 1000); // –ß–µ–º –±–æ–ª—å—à–µ —Å–æ–±—Ä–∞–ª, —Ç–µ–º –≤—ã—à–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å
            const winAmount = currentBet * winMultiplier;
            userBalance += winAmount;
            
            saveHighScore(score, currentBet);
            updateBalanceDisplay();
            loadLeaderboard();
            
            resultTitle.textContent = 'üéÆ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
            resultDetails.innerHTML = `
                <p>üíé –°–æ–±—Ä–∞–Ω–æ –º–æ–Ω–µ—Ç: <strong>${score}</strong></p>
                <p>üí∞ –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: <strong>${currentBet} TON</strong></p>
                <p>üéØ –í—ã–∏–≥—Ä—ã—à: <strong>${winAmount.toFixed(2)} TON</strong></p>
                <p>üíµ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: <strong>${userBalance.toFixed(2)} TON</strong></p>
                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                    üí° –°–æ–±–µ—Ä–∏—Ç–µ 1000+ –º–æ–Ω–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
                </p>
            `;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
            currentBet = 0;
        }

        // –°–±—Ä–æ—Å –∏–≥—Ä—ã
        function resetGame() {
            gameResult.style.display = 'none';
            afterConnect.style.display = 'block';
            updateWalletInfo();
        }

        // –°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∞ —Å –∫–æ–º–∏—Å—Å–∏–µ–π 10%
        function showWithdrawModal() {
            const availableTON = Math.floor(gameCoins / 1000) * 45;
            if (availableTON === 0) {
                alert('–ú–∏–Ω–∏–º—É–º 1000 –º–æ–Ω–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞!\n–°–æ–±–µ—Ä–∏—Ç–µ –µ—â—ë ' + (1000 - gameCoins) + ' –º–æ–Ω–µ—Ç');
                return;
            }
            
            // –†–∞—Å—á–µ—Ç —Å –∫–æ–º–∏—Å—Å–∏–µ–π
            const commission = availableTON * 0.10; // 10% –∫–æ–º–∏—Å—Å–∏—è —Ç–µ–±–µ
            const playerGets = availableTON - commission;
            
            if (confirm(
                `üí∏ –ó–ê–ü–†–û–° –ù–ê –í–´–í–û–î\n\n` +
                `üí∞ –í–∞—à–∏ –º–æ–Ω–µ—Ç—ã: ${gameCoins}\n` +
                `üìä –ö—É—Ä—Å: 1000 –º–æ–Ω–µ—Ç = 45 TON\n` +
                `üéØ –ö –ø–æ–ª—É—á–µ–Ω–∏—é: ${playerGets} TON\n` +
                `‚ö° –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: ${commission} TON (10%)\n\n` +
                `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–≤–æ–¥?`
            )) {
                processRealWithdrawal(playerGets, commission);
            }
        }

        // –†–µ–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ TON Connect
        async function processRealWithdrawal(playerAmount, commission) {
            if (!playerWallet) {
                alert('‚ùå –ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                return;
            }
            
            // –¢–í–û–ô –ö–û–®–ï–õ–ï–ö –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏
            const YOUR_WALLET = "UQAWQh7zmJcdgsnBzwMwQCVaW_chq_xid7TO2TmSWxnueN_W";
            
            try {
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 600, // 10 –º–∏–Ω—É—Ç
                    messages: [
                        {
                            address: YOUR_WALLET, // –ö–û–ú–ò–°–°–ò–Ø —Ç–µ–±–µ
                            amount: (commission * 1000000000).toString() // –≤ –Ω–∞–Ω–æ–∫–µ–Ω–∞—Ö
                        },
                        {
                            address: playerWallet.account.address, // –ò–≥—Ä–æ–∫—É
                            amount: (playerAmount * 1000000000).toString()
                        }
                    ]
                };
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                const result = await tonConnectUI.sendTransaction(transaction);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–∞
                gameCoins = gameCoins % 1000; // –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫
                localStorage.setItem('tonBlastGameCoins', gameCoins.toString());
                userBalance += playerAmount; // –ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –≤—ã–∏–≥—Ä—ã—à
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∏—Å—Å–∏—é –≤ —Ç–≤–æ—é –ø—Ä–∏–±—ã–ª—å
                profitTracker.addProfit(commission);
                
                updateBalanceDisplay();
                
                alert(`‚úÖ –í—ã–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω!\n\n` +
                      `üì§ –ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∏–ª: ${playerAmount} TON\n` +
                      `üí∞ –í–∞—à–∞ –∫–æ–º–∏—Å—Å–∏—è: ${commission} TON\n` +
                      `üíé –û—Å—Ç–∞–ª–æ—Å—å –º–æ–Ω–µ—Ç: ${gameCoins}`);
                      
            } catch (error) {
                console.error('Withdrawal error:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞: ' + error.message);
            }
        }

        // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
        function loadLeaderboard() {
            const scores = JSON.parse(localStorage.getItem('tonBlastLeaderboard') || '[]');
            leaderboardElement.innerHTML = scores.slice(0, 5).map((score, index) => `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div>üíé ${score.points} –º–æ–Ω–µ—Ç</div>
                    <div class="leaderboard-score">${score.bet} TON</div>
                </div>
            `).join('') || '<p style="text-align: center; color: #666;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>';
        }

        function saveHighScore(points, bet) {
            const scores = JSON.parse(localStorage.getItem('tonBlastLeaderboard') || '[]');
            scores.push({
                points: points,
                bet: bet,
                date: new Date().toLocaleDateString('ru-RU')
            });
            scores.sort((a, b) => b.points - a.points);
            localStorage.setItem('tonBlastLeaderboard', JSON.stringify(scores.slice(0, 10)));
        }

        // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
        function copyReferralLink() {
            const link = `https://t.me/${tg.initDataUnsafe.user?.username || 'tonblast'}?start=ref_${tg.initDataUnsafe.user?.id || '123'}`;
            navigator.clipboard.writeText(link);
            alert('‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }

        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
        function shareResult() {
            if (tg.isVersionAtLeast('6.1')) {
                tg.shareMessage({
                    text: `üéÆ –Ø —Å–æ–±—Ä–∞–ª ${score} –º–æ–Ω–µ—Ç –≤ TON Blast Game –∏ –≤—ã–∏–≥—Ä–∞–ª ${(currentBet * (1 + score/1000)).toFixed(2)} TON! –°–º–æ–∂–µ—à—å –ø–æ–±–∏—Ç—å –º–æ–π —Ä–µ–∫–æ—Ä–¥? üèÜ\n\n–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è: https://t.me/tonblast_bot`
                });
            } else {
                copyReferralLink();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            initTonConnect();
            loadLeaderboard();
            updateBalanceDisplay();
            profitTracker.loadFromLocalStorage();
        };
    </script>
</body>
</html>