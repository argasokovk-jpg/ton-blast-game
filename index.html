<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Blast - Crypto Arcade</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --ton-black: #1a1a1a;
            --ton-dark: #2d2d2d;
            --ton-blue: #0088cc;
            --ton-light-blue: #00a8ff;
            --ton-gold: #ffd700;
            --ton-green: #00c781;
            --ton-red: #ff4757;
            --ton-purple: #7e57c2;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--ton-black);
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--ton-dark);
            min-height: 100vh;
            position: relative;
        }
        
        /* TON Header */
        .ton-header {
            background: linear-gradient(135deg, var(--ton-black), var(--ton-blue));
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-bottom: 3px solid var(--ton-blue);
            position: relative;
            overflow: hidden;
        }
        
        .ton-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--ton-gold), transparent);
        }
        
        .ton-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0, 136, 204, 0.5);
        }
        
        .ton-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        #user-info {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        #owner-profit {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            border: 1px solid var(--ton-blue);
        }
        
        .content-section {
            padding: 20px;
        }
        
        /* TON Cards */
        .ton-card {
            background: linear-gradient(135deg, var(--ton-dark), #363636);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #404040;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .ton-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--ton-blue), transparent);
        }
        
        .wallet-card {
            border-left: 4px solid var(--ton-blue);
        }
        
        .premium-card {
            border-left: 4px solid var(--ton-gold);
            background: linear-gradient(135deg, #2d2d2d, #3a3a3a);
        }
        
        .stats-card {
            border-left: 4px solid var(--ton-purple);
        }
        
        h2 {
            color: white;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
        }
        
        h3 {
            color: var(--ton-light-blue);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        /* TON Buttons */
        .ton-button {
            background: linear-gradient(135deg, var(--ton-blue), var(--ton-light-blue));
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 8px 0;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
            transition: all 0.3s ease;
            display: block;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ton-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .ton-button:hover::before {
            left: 100%;
        }
        
        .ton-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 136, 204, 0.5);
        }
        
        .ton-button.secondary {
            background: linear-gradient(135deg, var(--ton-green), #00e5a0);
        }
        
        .ton-button.premium {
            background: linear-gradient(135deg, var(--ton-gold), #ffed4e);
            color: var(--ton-black);
            font-weight: bold;
        }
        
        .ton-button.small {
            padding: 12px 20px;
            font-size: 14px;
            width: auto;
            margin: 5px;
            display: inline-block;
        }
        
        .ton-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .ton-button:disabled:hover::before {
            left: -100%;
        }
        
        /* Status Messages */
        .status-message {
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .status-success {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid var(--ton-green);
            color: var(--ton-green);
        }
        
        .status-error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--ton-red);
            color: var(--ton-red);
        }
        
        .status-info {
            background: rgba(0, 136, 204, 0.1);
            border: 1px solid var(--ton-blue);
            color: var(--ton-blue);
        }
        
        /* Game Area */
        #game-area {
            position: relative;
            width: 100%;
            height: 400px;
            border: 2px solid var(--ton-blue);
            border-radius: 15px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }
        
        /* TON Coins */
        .ton-coin {
            width: 70px;
            height: 70px;
            background: radial-gradient(circle at 30% 30%, var(--ton-blue), #0066aa, #004477);
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 
                0 0 25px rgba(0, 136, 204, 0.8),
                inset 0 0 25px rgba(255, 255, 255, 0.3),
                0 0 0 3px rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            animation: float 3s infinite ease-in-out;
            transition: all 0.3s ease;
        }
        
        .ton-coin.premium {
            background: radial-gradient(circle at 30% 30%, var(--ton-gold), #ffaa00, #cc8800);
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.4),
                0 0 0 3px rgba(255, 255, 255, 0.7);
        }
        
        .ton-coin::before {
            content: "üíé";
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .ton-coin:hover {
            transform: scale(1.15);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        /* Game Info */
        .game-info {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .timer {
            color: var(--ton-red);
            background: rgba(231, 76, 60, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--ton-red);
        }
        
        .score {
            color: var(--ton-green);
            background: rgba(39, 174, 96, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--ton-green);
        }
        
        /* Game Results */
        #game-result {
            display: none;
            text-align: center;
        }
        
        .result-card {
            background: linear-gradient(135deg, #1e3a1e, #2d4a2d);
            border-left: 4px solid var(--ton-green);
        }
        
        /* Limits & Premium */
        .limits-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--ton-gold);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .premium-features {
            background: rgba(255, 215, 0, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .premium-badge {
            background: var(--ton-gold);
            color: var(--ton-black);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        /* Balance Info */
        .balance-info {
            background: rgba(0, 136, 204, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid var(--ton-blue);
        }
        
        .commission-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--ton-gold);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        /* Bet Buttons */
        .bet-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
            justify-content: center;
        }
        
        /* Back Button */
        .back-button {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--ton-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .content-section {
                padding: 15px;
            }
            
            .ton-header {
                padding: 20px 15px;
            }
            
            .ton-header h1 {
                font-size: 24px;
            }
            
            #game-area {
                height: 350px;
            }
            
            .ton-coin {
                width: 60px;
                height: 60px;
            }
            
            .bet-buttons .ton-button.small {
                flex: 1;
                min-width: 70px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- TON Header -->
        <div class="ton-header">
            <button class="back-button" onclick="backToMain()" style="display: none;">‚Üê Back</button>
            <h1>üíé TON BLAST</h1>
            <div class="ton-subtitle">Crypto Arcade Game</div>
            <div id="user-info">Loading user...</div>
            <div id="owner-profit" style="display: none;">Owner Profit: 0.00 TON</div>
        </div>
        
        <div class="content-section">
            <!-- Wallet Card -->
            <div class="ton-card wallet-card" id="wallet-section">
                <h2>üîó TON Wallet</h2>
                <div id="wallet-info">
                    <p>Connect your TON wallet to start playing and earn real cryptocurrency</p>
                    <button class="ton-button" onclick="connectWallet()" id="connect-wallet-btn">
                        üéØ Connect TON Wallet
                    </button>
                    <!-- Demo Mode Button -->
                    <button class="ton-button secondary" onclick="enableDemoMode()">
                        üéÆ Try Demo Mode (No Wallet Needed)
                    </button>
                </div>
                
                <!-- Wallet Connection Status -->
                <div id="wallet-status"></div>
                
                <!-- After Wallet Connect -->
                <div id="after-connect" style="display: none; margin-top: 15px;">
                    <h3>üí∞ Your Balance</h3>
                    <div class="balance-info">
                        <div style="font-size: 18px; font-weight: bold; color: var(--ton-blue);">
                            üíé <span id="game-coins-balance">0</span> coins
                        </div>
                        <div style="font-size: 16px; color: #ccc; margin-top: 5px;">
                            üíµ <span id="ton-balance">0</span> TON
                        </div>
                    </div>

                    <!-- Game Limits -->
                    <div class="limits-info" id="limits-section">
                        <h4>üéØ Daily Game Limits</h4>
                        <p style="font-size: 14px; margin: 5px 0;">
                            <span id="games-played">0</span>/<span id="games-limit">5</span> games today
                        </p>
                        <div id="premium-status" style="font-size: 12px; color: #ccc;">
                            ‚≠ê Regular User
                        </div>
                    </div>

                    <div class="commission-info">
                        <h4>‚ö° Payout System</h4>
                        <p style="font-size: 14px; margin: 5px 0;">
                            üí∞ 1000 coins = 4.5 TON<br>
                            üéØ Commission: 10%<br>
                            üìä You get: 4.05 TON
                        </p>
                    </div>
                    
                    <h3>üéØ Place Your Bet</h3>
                    <div class="bet-buttons">
                        <button class="ton-button small" onclick="placeBet(1)">1 TON</button>
                        <button class="ton-button small" onclick="placeBet(2)">2 TON</button>
                        <button class="ton-button small" onclick="placeBet(5)">5 TON</button>
                        <button class="ton-button small" onclick="placeBet(10)">10 TON</button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="ton-button success" onclick="showWithdrawModal()" style="flex: 1;">
                            üí∏ Withdraw Funds
                        </button>
                        <button class="ton-button" onclick="disconnectWallet()" style="flex: 1;">
                            üîå Disconnect
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Premium Card -->
            <div class="ton-card premium-card">
                <h3>‚≠ê PREMIUM ACCESS <span class="premium-badge">GOLD</span></h3>
                <div class="premium-features">
                    <p>üöÄ <strong>20 games/day</strong> (instead of 5)</p>
                    <p>üíé <strong>2x coins per gem</strong> (20 coins)</p>
                    <p>üéØ <strong>Higher win multipliers</strong></p>
                    <p>‚ö° <strong>Priority support</strong></p>
                </div>
                <button class="ton-button premium" onclick="buyPremium()">
                    üí∞ Upgrade for 10 TON
                </button>
            </div>
            
            <!-- Game Stats -->
            <div class="ton-card stats-card" id="game-stats" style="display: none;">
                <div class="game-info">
                    <div class="timer">‚è±Ô∏è <span id="time-left">30</span>s</div>
                    <div class="score">üíé <span id="coins-count">0</span></div>
                </div>
                <div style="text-align: center; color: #ccc; margin: 10px 0;">
                    üí∞ Bet: <span id="current-bet">0</span> TON | 
                    Available: <span id="withdraw-amount">0</span> TON
                </div>
            </div>
            
            <!-- Game Area -->
            <div id="game-area"></div>
            
            <!-- Game Results -->
            <div class="ton-card result-card" id="game-result">
                <h2 id="result-title">üéÆ Game Completed!</h2>
                <div id="result-details" style="margin: 15px 0;"></div>
                <button class="ton-button" onclick="resetGame()">üîÑ Play Again</button>
                <button class="ton-button secondary" onclick="shareResult()">üì§ Share Result</button>
            </div>
        </div>
    </div>

    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <script>
        // Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Game Logic
        let score = 0;
        let gameTimer = 30;
        let timerInterval;
        let gameInterval;
        let playerWallet = null;
        let tonConnectUI;
        let currentBet = 0;
        let userBalance = 50;
        let gameCoins = parseInt(localStorage.getItem('tonBlastGameCoins') || '0');
        let isPremium = localStorage.getItem('tonBlastPremium') === 'true';
        let gamesPlayedToday = 0;
        let lastPlayDate = localStorage.getItem('tonBlastLastPlayDate');

        const gameArea = document.getElementById('game-area');
        const walletSection = document.getElementById('wallet-section');
        const gameStats = document.getElementById('game-stats');
        const gameResult = document.getElementById('game-result');
        const resultTitle = document.getElementById('result-title');
        const resultDetails = document.getElementById('result-details');
        const afterConnect = document.getElementById('after-connect');
        const ownerProfitElement = document.getElementById('owner-profit');
        const backButton = document.querySelector('.back-button');
        const walletStatus = document.getElementById('wallet-status');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');

        // Initialize user info
        if (tg.initDataUnsafe.user) {
            let user = tg.initDataUnsafe.user;
            let userName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            document.getElementById('user-info').innerHTML = `üë§ <strong>${userName}</strong>`;
        }

        // Game Limits System
        function updateGameLimits() {
            const today = new Date().toDateString();
            
            // Reset if new day
            if (lastPlayDate !== today) {
                gamesPlayedToday = 0;
                lastPlayDate = today;
                localStorage.setItem('tonBlastLastPlayDate', today);
                localStorage.setItem('tonBlastGamesPlayed', '0');
            } else {
                gamesPlayedToday = parseInt(localStorage.getItem('tonBlastGamesPlayed') || '0');
            }
            
            const gamesLimit = isPremium ? 20 : 5;
            const gamesLeft = gamesLimit - gamesPlayedToday;
            
            document.getElementById('games-played').textContent = gamesPlayedToday;
            document.getElementById('games-limit').textContent = gamesLimit;
            
            // Update premium status
            const premiumStatus = document.getElementById('premium-status');
            if (isPremium) {
                premiumStatus.innerHTML = '‚≠ê <strong>PREMIUM USER</strong>';
                premiumStatus.style.color = 'var(--ton-gold)';
            } else {
                premiumStatus.innerHTML = '‚≠ê Regular User - <a href="#" onclick="buyPremium()" style="color: var(--ton-gold); text-decoration: none;">Upgrade to Premium</a>';
            }
            
            return gamesLeft > 0;
        }

        function incrementGamesPlayed() {
            gamesPlayedToday++;
            localStorage.setItem('tonBlastGamesPlayed', gamesPlayedToday.toString());
            updateGameLimits();
        }

        // Profit Tracker
        const profitTracker = {
            totalCommission: 0,
            totalWithdrawals: 0,
            
            addProfit: function(commission) {
                this.totalCommission += commission;
                this.totalWithdrawals++;
                this.saveToLocalStorage();
                this.displayProfit();
            },
            
            displayProfit: function() {
                if (ownerProfitElement) {
                    ownerProfitElement.style.display = 'inline-block';
                    ownerProfitElement.innerHTML = `üëë Owner Profit: ${this.totalCommission.toFixed(2)} TON`;
                }
            },
            
            saveToLocalStorage: function() {
                localStorage.setItem('tonBlastOwnerProfit', JSON.stringify({
                    commission: this.totalCommission,
                    withdrawals: this.totalWithdrawals
                }));
            },
            
            loadFromLocalStorage: function() {
                const saved = JSON.parse(localStorage.getItem('tonBlastOwnerProfit') || '{"commission":0,"withdrawals":0}');
                this.totalCommission = saved.commission;
                this.totalWithdrawals = saved.withdrawals;
                this.displayProfit();
            }
        };

        // TON Connect Initialization - FIXED VERSION
        function initTonConnect() {
            try {
                const manifest = {
                    "url": "https://ton-blast-game.vercel.app",
                    "name": "TON Blast Game",
                    "iconUrl": "https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/test-dapp/icon.png"
                };
                
                // Check if TON_CONNECT_UI is available
                if (typeof TON_CONNECT_UI === 'undefined') {
                    showWalletStatus('TON Connect UI not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifest: manifest,
                    buttonRootId: 'ton-connect-button'
                });
                
                // Listen for connection changes
                tonConnectUI.onStatusChange(wallet => {
                    if (wallet) {
                        playerWallet = wallet;
                        updateWalletInfo();
                        showWalletStatus('‚úÖ Wallet connected successfully!', 'success');
                    } else {
                        playerWallet = null;
                        showWalletStatus('üîå Wallet disconnected', 'info');
                    }
                });
                
                // Restore existing connection
                tonConnectUI.connectionRestored.then(() => {
                    console.log('Connection restore attempted');
                });
                
            } catch (error) {
                console.error('TON Connect init error:', error);
                showWalletStatus('‚ùå Wallet connection failed. Please try again.', 'error');
            }
        }

        // Show wallet status messages
        function showWalletStatus(message, type) {
            walletStatus.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                walletStatus.innerHTML = '';
            }, 5000);
        }

        // Demo Mode
        function enableDemoMode() {
            playerWallet = { 
                account: { 
                    address: "UQDEMO1234567890DEMO1234567890DEMO1234567890DEMO",
                    chain: "-239"
                } 
            };
            userBalance = 100;
            isPremium = true; // Demo gets premium features
            updateWalletInfo();
            
            document.getElementById('wallet-info').innerHTML = `
                <h3>üéÆ DEMO MODE ACTIVATED</h3>
                <p style="color: #ccc; font-size: 14px;">Test all premium features without real TON</p>
                <div class="status-message status-success">
                    ‚≠ê Premium features enabled for testing
                </div>
                <button class="ton-button" onclick="connectWallet()" style="margin-top: 10px;">
                    üîó Connect Real Wallet
                </button>
            `;
        }

        // Back to Main
        function backToMain() {
            gameArea.style.display = 'none';
            gameStats.style.display = 'none';
            gameResult.style.display = 'none';
            afterConnect.style.display = 'block';
            backButton.style.display = 'none';
        }

        // Wallet Functions - IMPROVED
        async function connectWallet() {
            try {
                if (!tonConnectUI) {
                    initTonConnect();
                }
                
                showWalletStatus('üîÑ Connecting wallet...', 'info');
                connectWalletBtn.innerHTML = '<span class="loading"></span> Connecting...';
                connectWalletBtn.disabled = true;
                
                await tonConnectUI.connectWallet();
                
            } catch (error) {
                console.error('Connection error:', error);
                showWalletStatus('‚ùå Connection failed. Please try again.', 'error');
                connectWalletBtn.innerHTML = 'üéØ Connect TON Wallet';
                connectWalletBtn.disabled = false;
            }
        }

        function disconnectWallet() {
            if (tonConnectUI) {
                tonConnectUI.disconnect();
            }
            playerWallet = null;
            afterConnect.style.display = 'none';
            document.getElementById('wallet-info').innerHTML = `
                <p>Connect your TON wallet to start playing and earn real cryptocurrency</p>
                <button class="ton-button" onclick="connectWallet()" id="connect-wallet-btn">
                    üéØ Connect TON Wallet
                </button>
                <button class="ton-button secondary" onclick="enableDemoMode()">
                    üéÆ Try Demo Mode (No Wallet Needed)
                </button>
            `;
            showWalletStatus('üîå Wallet disconnected', 'info');
        }

        function updateWalletInfo() {
            if (playerWallet) {
                const shortAddress = playerWallet.account.address.slice(0, 8) + '...' + playerWallet.account.address.slice(-8);
                document.getElementById('wallet-info').innerHTML = `
                    <h3>‚úÖ Wallet Connected</h3>
                    <p style="font-size: 14px; color: #ccc; margin: 10px 0;">Address: ${shortAddress}</p>
                `;
                
                afterConnect.style.display = 'block';
                updateBalanceDisplay();
                updateGameLimits();
                
                gameStats.style.display = 'block';
                profitTracker.loadFromLocalStorage();
                
                connectWalletBtn.innerHTML = 'üéØ Connect TON Wallet';
                connectWalletBtn.disabled = false;
            }
        }

        function updateBalanceDisplay() {
            document.getElementById('game-coins-balance').textContent = gameCoins;
            document.getElementById('ton-balance').textContent = userBalance.toFixed(2);
            document.getElementById('withdraw-amount').textContent = (Math.floor(gameCoins / 1000) * 4.05).toFixed(2);
        }

        // Betting System
        function placeBet(amount) {
            if (!updateGameLimits()) {
                alert('‚ùå Daily game limit reached! Upgrade to Premium for more games.');
                return;
            }
            
            if (userBalance < amount) {
                alert('‚ùå Insufficient TON balance!');
                return;
            }
            
            currentBet = amount;
            userBalance -= amount;
            
            afterConnect.style.display = 'none';
            backButton.style.display = 'block';
            
            document.getElementById('wallet-info').innerHTML += `
                <div style="background: rgba(0, 136, 204, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px; text-align: center; border: 1px solid var(--ton-blue);">
                    <h3>üí∞ Bet Placed!</h3>
                    <p style="font-size: 18px; font-weight: bold; color: var(--ton-blue);">${amount} TON</p>
                    <button class="ton-button" onclick="startGame()" style="margin-top: 10px;">
                        üöÄ Start Game
                    </button>
                </div>
            `;
            
            updateBalanceDisplay();
            document.getElementById('current-bet').textContent = currentBet;
        }

        // Game Functions
        function startGame() {
            score = 0;
            gameTimer = 30;
            updateGameUI();
            
            gameArea.style.display = 'block';
            gameArea.innerHTML = '';
            gameResult.style.display = 'none';
            
            startTimer();
            createCoins();
            incrementGamesPlayed();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                gameTimer--;
                document.getElementById('time-left').textContent = gameTimer;
                
                if (gameTimer <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        function createCoins() {
            clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                createSingleCoin();
            }, 800);
        }

        function createSingleCoin() {
            const coin = document.createElement('div');
            coin.className = isPremium ? 'ton-coin premium' : 'ton-coin';
            
            const maxX = gameArea.offsetWidth - 80;
            const maxY = gameArea.offsetHeight - 80;
            coin.style.left = Math.random() * maxX + 'px';
            coin.style.top = Math.random() * maxY + 'px';
            
            coin.onclick = function() {
                collectCoin(this);
            };
            
            setTimeout(() => {
                if (coin.parentNode) {
                    coin.style.opacity = '0.5';
                    setTimeout(() => {
                        if (coin.parentNode) gameArea.removeChild(coin);
                    }, 500);
                }
            }, 4000);
            
            gameArea.appendChild(coin);
        }

        function collectCoin(coinElement) {
            coinElement.style.transform = 'scale(1.3)';
            coinElement.style.opacity = '0.7';
            
            setTimeout(() => {
                if (coinElement.parentNode) {
                    gameArea.removeChild(coinElement);
                    const coinsEarned = isPremium ? 20 : 10; // Premium gets 2x coins
                    score += coinsEarned;
                    gameCoins += coinsEarned;
                    localStorage.setItem('tonBlastGameCoins', gameCoins.toString());
                    updateGameUI();
                    updateBalanceDisplay();
                }
            }, 150);
        }

        function updateGameUI() {
            document.getElementById('coins-count').textContent = score;
            document.getElementById('withdraw-amount').textContent = (Math.floor(gameCoins / 1000) * 4.05).toFixed(2);
        }

        function endGame() {
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            
            gameArea.style.display = 'none';
            gameResult.style.display = 'block';
            
            // Premium gets better multipliers
            const baseMultiplier = isPremium ? 1.1 : 0.9;
            const scoreMultiplier = isPremium ? (score / 3000) : (score / 5000);
            const winMultiplier = baseMultiplier + scoreMultiplier;
            const winAmount = currentBet * winMultiplier;
            userBalance += winAmount;
            
            updateBalanceDisplay();
            
            resultTitle.textContent = 'üéÆ Game Completed!';
            resultDetails.innerHTML = `
                <p>üíé Coins collected: <strong>${score}</strong></p>
                <p>üí∞ Your bet: <strong>${currentBet} TON</strong></p>
                <p>üéØ Winnings: <strong>${winAmount.toFixed(2)} TON</strong></p>
                <p>üíµ Total balance: <strong>${userBalance.toFixed(2)} TON</strong></p>
                <p style="color: #ccc; font-size: 14px; margin-top: 10px;">
                    üí° Collect 1000+ coins to withdraw
                </p>
            `;
            
            currentBet = 0;
        }

        function resetGame() {
            backToMain();
            updateWalletInfo();
        }

        // Premium System
        function buyPremium() {
            if (userBalance < 10) {
                alert('‚ùå Need 10 TON to buy Premium');
                return;
            }
            
            if (confirm(`Upgrade to PREMIUM for 10 TON?\n\n‚≠ê 20 games/day\nüíé 2x coins per gem\nüéØ Better multipliers\n‚ö° Priority support`)) {
                userBalance -= 10;
                isPremium = true;
                localStorage.setItem('tonBlastPremium', 'true');
                updateWalletInfo();
                updateBalanceDisplay();
                alert('‚úÖ Premium activated! Enjoy exclusive benefits!');
            }
        }

        // Withdrawal System
        function showWithdrawModal() {
            const availableTON = Math.floor(gameCoins / 1000) * 4.5;
            if (availableTON === 0) {
                alert('Minimum 1000 coins to withdraw!\nYou need ' + (1000 - gameCoins) + ' more coins');
                return;
            }
            
            const commission = availableTON * 0.10;
            const playerGets = availableTON - commission;
            
            if (confirm(
                `üí∏ WITHDRAWAL REQUEST\n\n` +
                `üí∞ Your coins: ${gameCoins}\n` +
                `üìä Rate: 1000 coins = 4.5 TON\n` +
                `üéØ You receive: ${playerGets.toFixed(2)} TON\n` +
                `‚ö° Platform fee: ${commission.toFixed(2)} TON (10%)\n\n` +
                `Confirm withdrawal?`
            )) {
                processRealWithdrawal(playerGets, commission);
            }
        }

        async function processRealWithdrawal(playerAmount, commission) {
            if (!playerWallet) {
                alert('‚ùå Wallet not connected');
                return;
            }
            
            const YOUR_WALLET = "UQAWQh7zmJcdgsnBzwMwQCVaW_chq_xid7TO2TmSWxnueN_W";
            
            try {
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 600,
                    messages: [
                        {
                            address: YOUR_WALLET,
                            amount: (commission * 1000000000).toString()
                        },
                        {
                            address: playerWallet.account.address,
                            amount: (playerAmount * 1000000000).toString()
                        }
                    ]
                };
                
                const result = await tonConnectUI.sendTransaction(transaction);
                
                gameCoins = gameCoins % 1000;
                localStorage.setItem('tonBlastGameCoins', gameCoins.toString());
                userBalance += playerAmount;
                
                profitTracker.addProfit(commission);
                
                updateBalanceDisplay();
                
                alert(`‚úÖ Withdrawal successful!\n\n` +
                      `üì§ You received: ${playerAmount.toFixed(2)} TON\n` +
                      `üí∞ Platform fee: ${commission.toFixed(2)} TON\n` +
                      `üíé Remaining coins: ${gameCoins}`);
                      
            } catch (error) {
                console.error('Withdrawal error:', error);
                alert('‚ùå Withdrawal failed: ' + error.message);
            }
        }

        // Share Results
        function shareResult() {
            const shareText = `üéÆ I collected ${score} coins in TON Blast and won ${(currentBet * (0.9 + score/5000)).toFixed(2)} TON! Can you beat my score? üèÜ\n\nJoin now: https://t.me/TONBlastGame_bot`;
            
            if (navigator.share) {
                navigator.share({ text: shareText });
            } else {
                navigator.clipboard.writeText(shareText);
                alert('‚úÖ Result copied to clipboard!');
            }
        }

        // Initialize
        window.onload = function() {
            initTonConnect();
            updateBalanceDisplay();
            profitTracker.loadFromLocalStorage();
            updateGameLimits();
        };
    </script>
</body>
</html>